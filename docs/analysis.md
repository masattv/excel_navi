# Excel業務特化型AIフォーミュラビルダー 要件定義書

## 1. 概要と目的

### アプリ名（仮称）
Excel業務特化型AIフォーミュラビルダー

### コンセプト
日本のビジネスシーンで頻出する Excel タスクや専門用語・商習慣に最適化された AI ベースの数式生成・解説プラットフォーム。

ユーザーが日本語で「〇〇を集計したい」「△△の消費税を自動計算したい」といった自然言語を入力すると、その業務シナリオに合った Excel 数式（および必要に応じて VBA／Google Apps Script）を生成し、かつ日本語で分かりやすく解説する。

### 主な狙い（Value Proposition）

#### 国内特化の精度
- 日本企業で実際に使われる会計・人事・販売管理などの業務ロジックにマッチした数式を提供
- 「会計年度の切り替え」「源泉徴収税率」「消費税率」「勤怠管理」など、日本特有のビジネス要件をサポート

#### 日本語プロンプト最適化
- 日本語の業務文書や会話表現を高精度に解釈するプロンプトエンジニアリング
- たとえば「売上合計から○○％引く」「四半期ごとのクラスタリング集計」など、日本語で入力した際の曖昧さを最小化

#### 即時性・学習サポート
- 生成した数式の動作ロジックをステップ・バイ・ステップで解説し、ユーザーが「なぜその数式になるのか」を理解できるようにする
- リアルタイムに近いレスポンスで数式を出力し、打ち合わせの合間やちょっとした Excel 作業時にすぐ活用できる UX を提供

#### VBA／Apps Script 生成
- 定型的な帳票（見積書・請求書・納品書など）の自動作成スクリプトを日本語で生成
- 「A 列に日付、B 列に品目、C 列に金額があるとき、消費税込みの合計を別シートに自動集計する」などの業務フローをコード化

## 2. ターゲットユーザーとユースケース

### 2.1 ターゲットユーザー

#### 中小企業〜大企業の各部門担当者
- 経理・財務、販売管理、購買、営業、総務、人事など、Excel を多用する部門で働く日本人ビジネスパーソン

#### フリーランス・個人事業主
- 顧客向けに見積書や請求書を作成する必要がある個人起業家・フリーランスのエンジニア、デザイナー、コンサルタント等

#### Excel 中級者〜上級者を目指す学習者
- すでに基本的な関数操作はできるが、複雑な業務ロジックを数式化したい人
- 自学自習中のビジネスパーソンや、社内研修の補助ツールとして利用したい人

### 2.2 主なユースケース

#### 売上集計（月次・四半期・年度別）
- 「本月／前月比の売上合計を出したい」「年度別売上を予実管理用にまとめたい」
- → SUMIFS、ARRAYFORMULA などを含んだ複雑数式を生成し、ロジックを解説

#### 消費税・内税／外税計算
- 「◯◯円（税込）の金額から税抜金額を逆算したい」「消費税を別セルで自動計算したい」
- → 日本の標準税率に合わせた数式や、小数点処理をきれいに行う方法も明示

#### 源泉徴収税の計算
- 「報酬金額の◯％を源泉徴収して、支払金額を自動算出したい」
- → 日本の源泉徴収税率（たとえば10.21％など）を前提にした IF 文や VLOOKUP を含むロジック

#### 勤怠管理・残業時間計算
- 「始業・終業時刻から残業時間を自動で計算したい」「月間総労働時間を集計したい」
- → 時刻計算の注意点（24時間超の扱い、休憩時間の差し引き）も含めた数式を生成

#### 請求書・見積書のテンプレート生成（VBA／Apps Script）
- 「A4 用紙で請求書を自動生成するマクロ」「Google スプレッドシートで見積書を作るスクリプト」
- → 標準の書式や自社ルールに沿ったレイアウトを反映するためのコード例を作成

#### 社内レポートの自動フォーマット
- 「売上データを特定フォーマット（PDF／印刷用）に整形したい」
- → VBA を使ったシート名変更、セル結合、罫線、フォント設定などのマクロコードを生成

#### 社内稟議書・経費精算の自動集計
- 「経費申請書の支払先ごとに合計金額をまとめたい」「日付ごとの集計表を作りたい」
- → 絞込・集計関数（SUMIF、SUMPRODUCT、ピボットの代替数式）を自動生成

## 3. 必要機能（Functional Requirements）

### 3.1 ユーザーインターフェース（UI/UX）

#### トップページ／ホーム画面
- サービス概要、利用方法の簡単な紹介
- 「数式を生成する」「テンプレートから選ぶ」「スクリプトを生成する」などのメニュー

#### プロンプト入力画面
- 日本語による自然言語入力欄（テキストエリア）
- 入力例（サンプル例文）やヒント表示（例えば「消費税計算」「売上集計」などをクリック一つで挿入できる）
- テンプレート選択ドロップダウン（会計／税務／勤怠などのカテゴリー別）
- 「送信（Generate）」ボタン

#### 生成結果表示画面
- 生成された Excel 数式をソースコードブロックで表示
- 数式の動作ロジック解説（ステップごとに箇条書き）
- ボタン：①クリップボードコピー、②Excel 形式でダウンロード（CSV 形式で簡易サンプル）、③再生成リクエスト

#### スクリプト（VBA／Apps Script）生成機能
- タブ切り替えで「数式生成」と「スクリプト生成」を切り替え
- スクリプト生成の場合、対象範囲（シート名、セル範囲）を指定する補助 UI
- コード自動生成後、解説付きで表示

#### テンプレートライブラリ／サンプル集
- カテゴリ別（会計、経理、販売管理、勤怠、人事、マーケティングなど）に事前定義されたテンプレートを一覧表示
- 各テンプレート名をクリックすると、数式およびサンプル説明が表示

#### ユーザーアカウント／認証（オプション）
- 無料利用時は認証不要とし、1 日あたりのリクエスト回数を制限
- 追加機能（履歴保存、生成結果のマイライブラリ登録など）は会員登録（メールアドレス＋パスワード）を想定
- OAuth（Google アカウントなど）連携は優先度低め

#### 履歴管理（オプション）
- 過去に生成した数式・スクリプトを「履歴」タブで一覧表示
- 各履歴アイテムごとに再生成、コピー、削除などの操作

#### 管理画面（バックエンド管理者向け）
- 生成テンプレートの追加・編集・削除
- 利用ログの確認（リクエスト数、人気のテンプレートなど）

### 3.2 AI 関連機能

#### 日本語プロンプト解析
- OpenAI API（または同等の大規模言語モデル）を用い、日本語ビジネス文脈に最適化したプロンプトエンジニアリング
- たとえば「売上表（月別）の△△～□□列から、今月の累計と前年同期対比を出す式を教えて」といった高度な要求に対応

#### 数式生成ロジック
- LLM（大規模言語モデル）から返却された「生数式」のプレーンテキストをフロントにそのまま表示
- 数式部分を強調（色やフォント）して可読性を高める

#### 解説生成
- AI に「なぜこの数式が成立するのか」を日本語でステップごとに解説させる仕組み
- 必要に応じて「よくあるエラーと対策」などの補足情報を生成

#### テンプレート関連 AI ロジック
- 各テンプレートに対し、「具体的にどのセル範囲にどの関数を入れればよいか」をモデルに指示する独自プロンプトを設計
- 定型的なテンプレートは、モデルへのリクエスト回数を抑えるためにサーバーサイドでキャッシュを保持可能

#### VBA／Apps Script コード生成
- ユーザーが指定した要件（セル範囲、書式設定、印刷設定など）を元に、AI にマクロコードを生成させる
- スクリプト例を示した後、「どこを編集すれば〇〇を変更できるか」といった補足コメントを自動付与

### 3.3 技術要件（Technical Requirements）

#### フレームワーク・ライブラリ

##### フロントエンド：Next.js（React）
- ページベースのルーティング（pages/ もしくは App Router の app/）
- サーバーサイドレンダリング（SSR）と静的生成（SSG）の適材適所で使い分け
- TypeScript 導入推奨
- UI コンポーネントライブラリ例：Material-UI、Chakra UI、Tailwind CSS（ぜひチーム内で検討）

##### バックエンド/API：
- Next.js の API Routes を活用し、AI リクエストをサーバーサイドで実行
- 環境変数（process.env.OPENAI_API_KEY など）で API キーを管理
- 必要に応じてキャッシュ層（Redis など）を導入し、同じテンプレート生成リクエストの呼び出しを高速化

##### AI プロバイダー：
- OpenAI GPT-3.5/4 など（将来的に日本語特化モデルを切り替える可能性あり）
- 予算や利用量が増えた場合は Azure OpenAI、AWS Bedrock 日本語モデルなどを検討

#### データ保存・管理
- テンプレート情報、ユーザー履歴、利用ログなどを保存するためのデータベース（RDBMS: PostgreSQL/MySQL）
- 認証ユーザー用にマイライブラリ機能を持たせる場合は、ユーザーごとのテーブル設計
- キャッシュや一時保存が必要な場合は Redis などインメモリストア

#### 認証・認可
- 無料ユーザーは匿名で利用し、IP アドレス単位のリクエスト数制限
- ログインユーザーは JWT（JSON Web Token）ベースのセッション管理、または NextAuth.js などライブラリ活用
- 管理画面へのアクセス制限（管理者ロール）

#### パフォーマンス・スケーラビリティ
- AI 生成部分は外部 API 呼び出しがボトルネックになるため、Next.js API ルートは非同期で実装し、ユーザー体験をブロックしないようにする
- キャッシュ機能で「よく使われる定型テンプレート」を事前生成・保存し、再リクエスト時は即座に返却
- レイテンシが長い場合は「生成中インジケーター」を表示し、ユーザーに進捗を知らせる

#### UI/UX 設計
- レスポンシブ対応（PC メイン想定だが、タブレット・スマホでも閲覧可能）
- ダークモード対応は必須ではないが、将来的に検討可能
- コード表示はシンタックスハイライトを適用（Prism.js、React-Highlight など）

#### ローカライズと日本語対応
- すべての UI ラベル・メッセージは日本語をメインとし、必要であれば英語への切り替えも検討（多言語対応機能は後回し可）
- 日本語プロンプト解析時に使う専用辞書や業務用語の語彙リストを維持し、プロンプトエンジニアリングのベースとする

#### セキュリティ
- ユーザーから受け取る自然言語をそのまま AI に投げる場合のインジェクション対策は不要だが、生成結果を必ずサニタイズして表示
- API キーはサーバーサイドでのみ利用し、クライアントには絶対に露出しない
- ペイロードの上限対策（たとえば、プロンプトや生成結果が非常に長くなるケースを想定し、最大文字数制限を設ける）

#### 運用・ログ管理
- AI リクエスト数、成功・失敗ログ、エラーレスポンスなどを CloudWatch Logs（AWS）やFargate用ログ、あるいは Vercel のログ機能で可視化
- ユーザー行動ログ（どのテンプレートが最も使われているか、よくあるプロンプト）などを分析し、テンプレート改善に反映

#### デプロイ環境
- Vercel、Netlify などの Next.js 最適化プラットフォームを推奨
- 環境変数（API キーや DB 接続情報）は Vercel の環境変数設定画面で管理
- CI/CD：GitHub Actions などで自動ビルド ⇒ テスト ⇒ プロダクションデプロイ

## 4. 機能要件の詳細とユーザーストーリー

### 4.1 プロンプト入力・数式生成

#### ユーザーストーリー
1. ユーザー はトップページの「数式を生成する」ボタンをクリックする
2. ユーザー は「今月の売上累計を取得したい」「消費税を8%から10%に切り替える方法を教えて」など、日本語で自由に入力する
3. システム は入力されたプロンプトを受け取り、内部で「数式生成用プロンプト」を AI に投げる
4. システム は AI から返却された数式を画面に表示し、必要に応じて数式中のセル範囲や関数の意味を日本語でステップごとに解説する
5. ユーザー は「クリップボードにコピー」「Excel に貼り付け用に CSV ダウンロード」ボタンを押して利用できる

#### 入力バリデーション
- プロンプト文字数上限設定（例：1,000 字）
- 特定の禁止キーワード（SQL インジェクションのようなものではなく、AI 乱用防止のための規約違反ワードなど）

#### AI プロンプト設計例
RAW プロンプト（ユーザー入力）: 「売上表で A 列が商品コード、B 列が金額、C 列が日付の場合、売上が 1000 円以上の行の金額合計を求める数式を教えて」

システム側で付与する前置プロンプト例:
```
あなたは日本の Excel 業務に詳しい AI アシスタントです。以下の要件に合わせて、セル参照形式の数式およびその解説を提供してください。  
・セル範囲は A 列（商品コード）、B 列（金額）、C 列（日付）  
・売上が 1000 円以上の行の金額合計を求める。  
・数式例: =SUMIFS(B:B, B:B, ">=1000")  
・さらに、数式の各部分の意味や、日付を含めた複雑な条件式も解説してください。  
```
これを API リクエストの messages に含めつつ、ユーザーの入力を最後に追加。

### 4.2 テンプレート選択機能

#### ユーザーストーリー
1. ユーザー は「テンプレート一覧」ページを開く
2. ユーザー はカテゴリ（会計、勤怠、税務など）を選択すると、そのカテゴリに属するテンプレートの一覧がカード表示される
3. ユーザー はテンプレートをクリックすると、「テンプレート詳細」画面に遷移し、概要説明・利用方法・サンプル数式が表示される
4. ユーザー は「このテンプレートで数式を生成する」ボタンを押すと、あらかじめ用意されたプロンプトが挿入され、数式生成画面に自動遷移

#### 実装イメージ
- テンプレート一覧: CMS（Headless CMS や DB テーブル）にテンプレート単位で登録
- テンプレート詳細:
  - テンプレート名（例：消費税計算／源泉徴収税計算）
  - 説明テキスト
  - 前提条件（データ構造、シート名など）
  - 生成サンプル数式
  - 「このテンプレートで生成」ボタン

### 4.3 スクリプト生成（VBA／Apps Script）

#### ユーザーストーリー
1. ユーザー は「スクリプト生成」タブを選択する
2. ユーザー は「スクリプト種別（VBA または Google Apps Script）」を選び、セル範囲やシート名をフォームで指定する
3. ユーザー は「請求書フォーマットに合わせて自動集計マクロを生成」などの要件を日本語で入力し、「生成」ボタンを押す
4. システム は AI に対し、指定された要件・範囲を含むプロンプトを構築し、マクロコードを生成して画面に表示
5. ユーザー は「コードをコピー」「.bas ファイルとしてダウンロード」ボタンを使い、そのまま Excel にインポートできる

#### 注意点
- スクリプト生成時の誤動作リスクを下げるため、生成コードには必ずコメント（"この部分を変更すれば〇〇が更新できます"）を自動付与
- Google Apps Script の場合は Google スプレッドシートのスプレッドシート ID 取得方法や実行権限について簡単に解説するリンクを表示

### 4.4 ユーザー認証・履歴保存（オプション）

#### ユーザーストーリー
1. ユーザー は「ログイン」ページからメールアドレス＋パスワードでサインアップ／ログイン
2. ユーザー はマイページで「過去に生成した数式」「お気に入りテンプレート」を確認できる
3. ユーザー は任意で「この数式をマイライブラリに保存」ボタンを押し、自身の保存用フォルダに追加できる
4. システム はユーザーごとに生成履歴テーブルを管理し、一定期間（例：1 年）保存

#### 実装イメージ
- 認証ライブラリ: NextAuth.js、Firebase Auth、Auth0 のいずれかを検討
- DB テーブル設計（例）
  - users：id / email / hashed_password / created_at / updated_at
  - templates：id / name / category / prompt_base / description / created_at / updated_at
  - history：id / user_id / prompt_text / result_text / template_id（NULL 可） / created_at
  - favorites：id / user_id / template_id / created_at

### 4.5 管理画面（バックエンド）

#### 機能一覧
- テンプレート管理
  - テンプレートの新規登録・編集・削除
  - カテゴリ管理（会計、勤怠、特定業種向けなど）
  - 「利用頻度」指標（生成回数）を元に人気テンプレートを可視化
- ユーザー／利用ログ管理
  - 新規登録ユーザー数の推移
  - 1 日あたりの AI リクエスト数
  - エラー発生数、エラー内容のトラッキング
- FAQ／ヘルプ管理
  - よくある質問と回答を登録し、フロントに反映
  - 生成結果に参考リンクを自動表示する場合のリンク管理

#### 実装イメージ
- 管理画面は Next.js の API Routes とは別に、認証済み管理者のみがアクセスできるルート（たとえば /admin）
- 管理者ロール判定は JWT のカスタムクレーム等で実装
- UI は MUI や Ant Design など、管理画面向けコンポーネントライブラリを活用

## 5. 非機能要件（Non-Functional Requirements）

### パフォーマンス
- AI リクエストは外部 API 呼び出しに依存するため、最大でも 2～3 秒以内にレスポンスを返す（キャッシュ活用で 1 秒以内を目指す）
- 生成中はローディングインジケーターやプログレスバーを表示し、「処理中」であることを明示

### 可用性・信頼性
- 99.9% 程度の稼働率を目標とし、Vercel（あるいは自身で構築した Kubernetes クラスター）にデプロイして障害時に自動復旧
- AI プロバイダー（OpenAI）が落ちている場合を想定し、「AI が現在利用できません」という旨のエラーメッセージとサポート連絡先を表示

### スケーラビリティ
- 利用者増加に備えて、Next.js のサーバーレス関数や Vercel Edge Functions で水平スケール可能な設計
- 将来的に料金体系をサブスクリプション化する場合、認証・決済周り（Stripe など）の追加検討

### セキュリティ
- HTTPS 通信強制
- CSP（Content Security Policy）を適切に設定し、クロスサイトスクリプティング（XSS）を防止
- API キーはサーバーサイド環境変数に厳重管理し、フロントに漏洩しない仕組み

### 拡張性・保守性
- コンポーネント単位で機能をモジュール化し、将来的に別言語（英語など）への翻訳や機能追加（財務分析ダッシュボード連携など）がしやすい構造
- プロンプトテンプレートは CMS（Headless＋DB）から動的に取得する形にして、開発者以外でも追加・更新できる仕組みに

### UI/UX
- 日本のビジネスパーソンが使いやすい UI を最優先し、以下を重視
  - 読みやすい日本語ラベル
  - ボタンやフォーム入力欄の余白（padding）やフォントサイズ（14～16px 以上）を確保
  - カラーリングはコーポレート向けに落ち着いた配色（ネイビー系、グレー系）
  - モバイルで見ても崩れないレスポンシブデザイン
  - アクセシビリティ：日本語スクリーンリーダー対応、キーボード操作に対応

## 6. Next.js プロジェクト構成例

```
excel-ai-formula-builder/
├── README.md
├── package.json
├── next.config.js
├── .env.local
├── public/
│   ├── favicon.ico
│   └── ...
├── src/
│   ├── pages/                     # ページルーティング（App Router を使う場合は src/app/）
│   │   ├── index.tsx              # トップページ
│   │   ├── generate.tsx           # 数式生成ページ
│   │   ├── script.tsx             # スクリプト生成ページ
│   │   ├── templates/             # テンプレート一覧・詳細ページ
│   │   │   ├── index.tsx          # テンプレート一覧
│   │   │   └── [id].tsx           # テンプレート詳細
│   │   ├── auth/                  # 認証関連ページ（ログイン、サインアップなど）
│   │   │   ├── login.tsx
│   │   │   └── signup.tsx
│   │   ├── history.tsx            # 履歴一覧ページ
│   │   └── admin/                 # 管理者画面（認証要）
│   │       ├── index.tsx
│   │       └── templates.tsx
│   ├── components/                # 汎用コンポーネント
│   │   ├── Layout.tsx
│   │   ├── Header.tsx
│   │   ├── Footer.tsx
│   │   ├── PromptInputForm.tsx    # プロンプト入力用フォーム
│   │   ├── TemplateCard.tsx       # テンプレート一覧カード
│   │   ├── CodeBlock.tsx          # シンタックスハイライト対応コード表示
│   │   ├── LoadingSpinner.tsx     # ローディングスピナー
│   │   └── ...
│   ├── lib/                       # ライブラリ・ユーティリティ関数
│   │   ├── ai-client.ts           # OpenAI クライアント初期化
│   │   ├── prompt-builder.ts      # 各種プロンプト生成ロジック
│   │   ├── db.ts                  # DB 接続用（Prisma ORM など）
│   │   └── auth.ts                # 認証ユーティリティ
│   ├── pages/api/                 # API Routes
│   │   ├── ai/generate-formula.ts # 数式生成用 API
│   │   ├── ai/generate-script.ts  # スクリプト生成用 API
│   │   ├── templates/             # テンプレート API（一覧・詳細取得）
│   │   └── auth/                  # 認証 API（ログイン・サインアップ）
│   ├── prisma/                    # Prisma を使う場合のスキーマ・マイグレーション
│   │   └── schema.prisma
│   └── styles/                    # グローバル CSS や Tailwind 設定
│       ├── globals.css
│       └── tailwind.config.js
├── prisma/                        # Prisma マイグレーションファイル
└── ...
```

## 7. 開発フェーズとマイルストーン

### フェーズ 1：プロトタイプ作成（2～4 週間）
- Next.js プロジェクトの立ち上げ、UI テンプレート組み込み
- AI 連携部分の動作確認（プロンプトに対して簡易数式を返す）
- 最小限の UI と「数式生成 → 結果表示」フローを実装
- 日本語 NLP のプロンプトチューニングを一つのユースケース（例：消費税計算）で集中的に行う

### フェーズ 2：テンプレート機能と履歴管理（4～6 週間）
- DB 設計・マイグレーション、テンプレート管理機能実装
- テンプレート一覧・詳細ページの完成、キャッシュ実装
- 履歴機能および簡易認証機能（メール＋パスワード）実装

### フェーズ 3：スクリプト生成機能と管理画面（4 週間）
- VBA／Apps Script 生成フローの実装とテスト
- 管理者向け管理画面（テンプレート CRUD、利用ログ可視化）の実装
- エラー処理・異常系テストの強化

### フェーズ 4：最適化・ローンチ準備（2～3 週間）
- UI/UX 改善、レスポンシブ対応、アクセシビリティテスト
- 負荷テスト、キャッシュ動作確認、異常系メッセージの最終調整
- ドキュメント整備、README 作成、デプロイ設定（Vercel など）

### フェーズ 5：正式リリース後の運用・改善
- ユーザーフィードバックを受けてイテレーション
- 日本市場特化用の辞書追加、ユースケース新規テンプレートの継続追加
- 決済機能（有料プラン）導入検討

## 8. 想定リスクと対策

| リスク項目 | 対策・備考 |
|------------|------------|
| AI 生成結果の精度が想定より低い | ・プロンプトエンジニアリングの改良を継続<br>・よくある誤回答パターンを DB に記録し、対策を共有 |
| プロンプトが曖昧で数式生成に失敗 | ・入力補助（プレースホルダ、サンプル文）を充実<br>・「生成できませんでした」という失敗メッセージと改善例を表示 |
| 月間利用量が無料枠を超過しコスト膨張 | ・ユーザーあたりの無料リクエスト回数制限<br>・有料プラン導入（トライアル期間の提供） |
| 日本特有の細かい業務ロジックに対応しきれない | ・ユーザーからのフィードバックループを確立し、テンプレートとプロンプトを速やかに更新 |
| セキュリティインシデント（APIキー漏洩、DB侵入など） | ・環境変数管理、IAM ロール・権限分離、WAF 導入<br>・定期的なセキュリティレビュー |

## 9. まとめ

### 価値
日本のビジネスパーソンが日常的に直面する Excel 業務を、言語・業務慣習の両面で最適化された数式・スクリプト生成ツールで支援することで、効率化と属人化解消を強力に後押しする。

### Next.js を活用した利点
API Routes を使ったサーバーサイドでの AI 連携、SSR や SSG による高速なページ遷移、Vercel へのデプロイ容易性、TypeScript での型安全性などをフル活用し、スケーラブルかつ保守性の高いアプリケーションを実現できる。

### 開発の優先順位
1. プロンプト入力→数式生成フローの実装および日本語精度チューニング
2. テンプレート機能・履歴機能の実装
3. スクリプト生成・管理画面の実装
4. UI/UX 最適化とパフォーマンスチューニング

上記要件をベースに、Next.js プロジェクトを立ち上げ、最速でプロトタイプを作成 → 日本市場向けの AI テンプレートを拡充 → 運用を回しながら継続的に改善していくことで、国内ユーザーにとって真に使いやすい「Excel業務特化型AIフォーミュラビルダー」を実現できると考えます。